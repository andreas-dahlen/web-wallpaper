<template>
  <div class="lane">

    <!-- CURRENT scene -->
    <component
      v-if="currentIndex !== null"
      :is="scenes[currentIndex]"
      class="scene"
      :style="currentStyle"
    />

    <!-- PREVIEW / INCOMING scene -->
    <component
      v-if="previewIndex !== null"
      :is="scenes[previewIndex]"
      class="scene"
      :style="incomingStyle"
    />

  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { swipeState } from '../scenes/wallpaper/lanes/SwipeState'
import { swipeEngine } from '../composables/swipeEngine'

import A from '../scenes/wallpaper/lanes/top/1A.vue'
import B from '../scenes/wallpaper/lanes/top/1B.vue'
import C from '../scenes/wallpaper/lanes/top/1C.vue'

defineOptions({ name: 'LaneCarousel' })

/* ------------------------------------------------------------------
   CONFIG
------------------------------------------------------------------ */
const lane = 'top'
const WIDTH = 352
const scenes = [A, B, C]

/* ------------------------------------------------------------------
   STATE
------------------------------------------------------------------ */
const currentIndex = ref(swipeState.top)

/* keep index in sync after commit */
watch(
  () => swipeState.top,
  (i) => {
    currentIndex.value = i
  }
)

/* ------------------------------------------------------------------
   SWIPE DERIVED STATE
------------------------------------------------------------------ */
const isActive = computed(
  () => swipeEngine.state.activeLane === lane
)

const delta = computed(() =>
  isActive.value ? swipeEngine.state.delta : 0
)

const dir = computed(() =>
  isActive.value ? swipeEngine.state.dir : null
)

/* compute preview index live (infinite loop safe) */
const previewIndex = computed(() => {
  if (!dir.value) return null

  const len = scenes.length
  const i = currentIndex.value

  if (dir.value === 'left')  return (i - 1 + len) % len
  if (dir.value === 'right') return (i + 1) % len
  return null
})

/* ------------------------------------------------------------------
   STYLES (LIVE PHYSICS)
------------------------------------------------------------------ */
const currentStyle = computed(() => ({
  transform: `translateX(${delta.value}px)`,
  transition: isActive.value ? 'none' : 'transform 300ms ease'
}))

const incomingStyle = computed(() => {
  if (!dir.value) return {}

  const offset =
    dir.value === 'left'  ?  WIDTH :
    dir.value === 'right' ? -WIDTH :
    0

  return {
    transform: `translateX(${delta.value + offset}px)`,
    transition: isActive.value ? 'none' : 'transform 300ms ease'
  }
})
</script>

<style scoped>
.lane {
  position: relative;
  width: 352px;
  height: 262px;
  overflow: hidden;
}

.scene {
  position: absolute;
  inset: 0;
  width: 352px;
  height: 262px;
  will-change: transform;
}
</style>
